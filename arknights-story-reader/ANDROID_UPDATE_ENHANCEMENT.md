# Android 自动更新功能增强

## 🎯 更新说明

为了解决某些设备上自动下载安装失败的问题，现在添加了**手动下载**选项作为备选方案。

## ✨ 新增功能

### 1. 手动下载按钮

当检测到新版本可用时，Android 用户现在可以看到两个选项：

- **立即更新**：自动下载并安装（原有功能）
- **手动下载**：打开 GitHub Release 页面，手动下载 APK

### 2. GitHub Release 链接

- 自动提取并保存 GitHub Release 页面链接
- 点击"手动下载"按钮会自动打开浏览器跳转到最新版本的 Release 页面
- 用户可以在 GitHub 上查看完整的版本说明，然后下载 APK

### 3. 增强的错误提示

当自动安装失败时，错误信息会明确提示用户：

```
如果自动安装失败，您可以：
1. 点击"手动下载"按钮前往 GitHub 下载最新版本
2. 点击"保存到下载文件夹"按钮将安装包保存到下载文件夹后手动安装
```

## 🔧 技术实现

### 修改的文件

1. **`src/hooks/useAppUpdater.ts`**
   - 在 `AndroidUpdateManifest` 类型中添加 `githubReleaseUrl` 字段
   - 更新 `toManifestFromGithubLatestRelease` 函数提取 Release URL
   - 新增 `openExternalUrl` 函数用于打开外部链接

2. **`src/components/Settings.tsx`**
   - 添加 `handleOpenGithubRelease` 回调函数
   - 在更新 UI 中添加"手动下载"按钮
   - 更新错误提示文本

### 代码变更摘要

```typescript
// useAppUpdater.ts
export type AndroidUpdateManifest = {
  version: string;
  url: string;
  fileName?: string | null;
  notes?: string | null;
  githubReleaseUrl?: string | null;  // 新增
};

export async function openExternalUrl(url: string): Promise<void> {
  // 打开外部链接，优先使用 Tauri 插件，回退到 window.open
}
```

```tsx
// Settings.tsx
{availableUpdate.platform === "android" && (
  <Button type="button" variant="outline" onClick={handleOpenGithubRelease}>
    <Download className="mr-2 h-4 w-4" />
    手动下载
  </Button>
)}
```

## 📱 用户体验流程

### 场景一：自动更新成功

1. 应用检测到新版本
2. 显示更新通知
3. 用户点击"立即更新"
4. 自动下载并安装 ✅

### 场景二：自动更新失败

1. 应用检测到新版本
2. 显示更新通知
3. 用户点击"立即更新"
4. 下载失败或安装权限问题 ❌
5. **用户点击"手动下载"按钮**
6. 打开浏览器跳转到 GitHub Release 页面
7. 用户手动下载并安装 APK ✅

### 场景三：主动选择手动下载

1. 应用检测到新版本
2. 显示更新通知
3. **用户直接点击"手动下载"按钮**（不尝试自动更新）
4. 打开浏览器跳转到 GitHub Release 页面
5. 用户查看版本说明，下载并安装 APK ✅

## 🎨 UI 展示

### 检测到更新时

```
┌─────────────────────────────────────┐
│ 应用更新                            │
├─────────────────────────────────────┤
│ 当前版本: 1.10.45                   │
│ 运行平台: Android                   │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ Android 新版本 1.10.46          │ │
│ │ • 修复已知问题                  │ │
│ │ • 性能优化                      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [ 检查更新 ]  [ 立即更新 ]  [ 手动下载 ] │
└─────────────────────────────────────┘
```

### 更新失败时

```
┌─────────────────────────────────────┐
│ ❌ 下载失败：网络异常                │
│                                     │
│ 如果自动安装失败，您可以：          │
│ 1. 点击"手动下载"按钮前往 GitHub    │
│    下载最新版本                     │
│ 2. 点击"保存到下载文件夹"按钮将安装 │
│    包保存后手动安装                 │
│                                     │
│ [ 检查更新 ]  [ 立即更新 ]  [ 手动下载 ] │
│              [ 保存到下载文件夹 ]    │
└─────────────────────────────────────┘
```

## 🔒 安全性

- 使用 GitHub 官方 Release API 获取更新信息
- Release URL 直接来自 GitHub API 响应，确保链接真实性
- 如果 API 未返回 URL，回退到默认的 `/releases/latest` 页面

## 🌐 兼容性

- ✅ 支持所有 Android 设备
- ✅ 自动适配不同的网络环境
- ✅ 优雅降级：如果 Tauri opener 插件不可用，回退到 `window.open`
- ✅ 向后兼容：不影响现有的自动更新流程

## 📊 优势对比

| 场景 | 原方案 | 新方案 |
|------|--------|--------|
| 网络环境差 | ❌ 下载失败，用户无法更新 | ✅ 可手动前往 GitHub 下载 |
| 权限限制 | ⚠️ 需要多次尝试权限设置 | ✅ 可直接手动下载安装 |
| 信任问题 | ⚠️ 某些用户不信任应用内下载 | ✅ GitHub 官方页面增强信任 |
| 查看更新说明 | ⚠️ 应用内显示有限 | ✅ GitHub 页面完整信息 |
| 下载速度 | ⚠️ 依赖设备网络配置 | ✅ 用户可选择更快的下载方式 |

## 🚀 未来改进

潜在的后续优化方向：

1. **多源下载**：添加国内镜像源选项（如 Gitee、OSS）
2. **下载管理器集成**：使用系统下载管理器提高稳定性
3. **断点续传**：支持大文件的断点续传
4. **版本对比**：显示当前版本和最新版本的详细对比
5. **更新频道**：支持稳定版/测试版切换

## 📝 总结

这次更新为 Android 用户提供了更灵活的更新方式，特别是在以下情况下非常有用：

- 🌐 网络环境不稳定
- 🔐 设备权限限制严格
- 👀 需要查看完整的更新说明
- 🎯 更倾向于手动控制更新流程

通过"自动更新"和"手动下载"的组合，确保所有用户都能顺利获取到最新版本！

