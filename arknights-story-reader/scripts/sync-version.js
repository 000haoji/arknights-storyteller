#!/usr/bin/env node

/**
 * ç‰ˆæœ¬å·è‡ªåŠ¨åŒæ­¥è„šæœ¬
 * 
 * åŠŸèƒ½ï¼šä» package.json è¯»å–ç‰ˆæœ¬å·ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰ç›¸å…³é…ç½®æ–‡ä»¶
 * ä½¿ç”¨ï¼šnpm run sync-version
 * 
 * åŒæ­¥çš„æ–‡ä»¶ï¼š
 * - src-tauri/Cargo.toml
 * - src-tauri/tauri.conf.json
 * - src-tauri/gen/android/app/tauri.properties
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// è·å–å½“å‰æ–‡ä»¶çš„ç›®å½•ï¼ˆESM ä¸­çš„ __dirname æ›¿ä»£ï¼‰
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// é¢œè‰²è¾“å‡º
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// è®¡ç®— Android versionCode
function calculateVersionCode(version) {
  const parts = version.split('.').map(Number);
  if (parts.length !== 3 || parts.some(isNaN)) {
    throw new Error(`æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: ${version}ï¼Œåº”è¯¥æ˜¯ x.y.z æ ¼å¼`);
  }
  const [major, minor, patch] = parts;
  return major * 10000 + minor * 100 + patch;
}

// è¯»å– package.json è·å–ç‰ˆæœ¬å·
function getVersionFromPackageJson() {
  const packageJsonPath = path.join(__dirname, '../package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
  return packageJson.version;
}

// æ›´æ–° Cargo.toml
function updateCargoToml(version) {
  const cargoPath = path.join(__dirname, '../src-tauri/Cargo.toml');
  let content = fs.readFileSync(cargoPath, 'utf8');
  
  const newContent = content.replace(
    /^version = ".*"$/m,
    `version = "${version}"`
  );
  
  if (content !== newContent) {
    fs.writeFileSync(cargoPath, newContent, 'utf8');
    log(`âœ… å·²æ›´æ–° Cargo.toml -> ${version}`, 'green');
    return true;
  }
  log(`â­ï¸  Cargo.toml ç‰ˆæœ¬å·²æ˜¯æœ€æ–° (${version})`, 'yellow');
  return false;
}

// æ›´æ–° tauri.conf.json
function updateTauriConfig(version, versionCode) {
  const configPath = path.join(__dirname, '../src-tauri/tauri.conf.json');
  const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
  
  let updated = false;
  
  if (config.version !== version) {
    config.version = version;
    updated = true;
  }
  
  if (!config.bundle) {
    config.bundle = {};
  }
  if (!config.bundle.android) {
    config.bundle.android = {};
  }
  
  if (config.bundle.android.versionCode !== versionCode) {
    config.bundle.android.versionCode = versionCode;
    updated = true;
  }
  
  if (updated) {
    fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + '\n', 'utf8');
    log(`âœ… å·²æ›´æ–° tauri.conf.json -> ${version} (versionCode: ${versionCode})`, 'green');
    return true;
  }
  
  log(`â­ï¸  tauri.conf.json ç‰ˆæœ¬å·²æ˜¯æœ€æ–° (${version}, versionCode: ${versionCode})`, 'yellow');
  return false;
}

// æ›´æ–° tauri.properties
function updateTauriProperties(version, versionCode) {
  const propertiesPath = path.join(__dirname, '../src-tauri/gen/android/app/tauri.properties');
  
  // ç¡®ä¿ç›®å½•å­˜åœ¨
  const dir = path.dirname(propertiesPath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  
  const content = `// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
tauri.android.versionName=${version}
tauri.android.versionCode=${versionCode}`;
  
  // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å†…å®¹æ˜¯å¦ç›¸åŒ
  if (fs.existsSync(propertiesPath)) {
    const existingContent = fs.readFileSync(propertiesPath, 'utf8');
    if (existingContent.trim() === content.trim()) {
      log(`â­ï¸  tauri.properties ç‰ˆæœ¬å·²æ˜¯æœ€æ–° (${version}, versionCode: ${versionCode})`, 'yellow');
      return false;
    }
  }
  
  fs.writeFileSync(propertiesPath, content, 'utf8');
  log(`âœ… å·²æ›´æ–° tauri.properties -> ${version} (versionCode: ${versionCode})`, 'green');
  return true;
}

// ä¸»å‡½æ•°
function main() {
  try {
    log('\nğŸ”„ å¼€å§‹åŒæ­¥ç‰ˆæœ¬å·...', 'blue');
    log('â”'.repeat(60), 'blue');
    
    // 1. è·å–ç‰ˆæœ¬å·
    const version = getVersionFromPackageJson();
    log(`\nğŸ“¦ ä» package.json è¯»å–ç‰ˆæœ¬: ${version}`, 'blue');
    
    // 2. è®¡ç®— versionCode
    const versionCode = calculateVersionCode(version);
    log(`ğŸ”¢ è®¡ç®— Android versionCode: ${versionCode}`, 'blue');
    
    // 3. æ›´æ–°å„ä¸ªæ–‡ä»¶
    log('\nğŸ“ æ›´æ–°é…ç½®æ–‡ä»¶:', 'blue');
    const updates = [
      updateCargoToml(version),
      updateTauriConfig(version, versionCode),
      updateTauriProperties(version, versionCode),
    ];
    
    // 4. æ€»ç»“
    log('\n' + 'â”'.repeat(60), 'blue');
    const updatedCount = updates.filter(Boolean).length;
    if (updatedCount > 0) {
      log(`\nâœ¨ å®Œæˆ! å·²æ›´æ–° ${updatedCount} ä¸ªæ–‡ä»¶`, 'green');
      log('\nğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:', 'blue');
      log(`   ç‰ˆæœ¬å·: ${version}`, 'blue');
      log(`   versionCode: ${versionCode}`, 'blue');
    } else {
      log('\nâœ¨ æ‰€æœ‰æ–‡ä»¶ç‰ˆæœ¬å·å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°', 'green');
    }
    log('');
    
  } catch (error) {
    log(`\nâŒ é”™è¯¯: ${error.message}`, 'red');
    process.exit(1);
  }
}

// è¿è¡Œ
main();

