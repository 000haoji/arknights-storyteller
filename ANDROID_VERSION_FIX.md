# Android APK 版本号修复说明

## 🐛 问题描述

**症状**：
- GitHub Release 显示版本 1.10.42
- 但手机安装后显示版本 1.0
- 无法正常升级安装

## 🔍 根本原因

Android APK 的版本号由 **`tauri.properties`** 文件控制，而这个文件：
1. 是自动生成的文件（头部注释说"DO NOT EDIT DIRECTLY"）
2. 被 `.gitignore` 忽略
3. **但 CI/CD 构建时没有正确生成/更新**
4. 导致使用了旧的默认值（0.1.0 / versionCode 1000）

### 问题文件位置
```
arknights-story-reader/src-tauri/gen/android/app/tauri.properties
```

### 错误的内容（修复前）
```properties
// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
tauri.android.versionName=0.1.0    ❌ 应该是 1.10.42
tauri.android.versionCode=1000     ❌ 应该是 11042
```

## ✅ 解决方案（当前版本：1.11.1）

### 1. 以 `package.json` 为唯一数据源
- 一切版本号都以 `package.json` 的 `version` 字段为准（当前为 **1.11.1**）
- Android `versionCode` 通过脚本按公式 `major * 10000 + minor * 100 + patch` 自动计算（当前为 **11101**）

### 2. 使用同步脚本更新所有配置
运行 `npm run sync-version`（或执行 `npm version patch|minor|major`，它会自动调用同步脚本）即可自动更新：
- `src-tauri/tauri.conf.json` → `version` 与 `bundle.android.versionCode`
- `src-tauri/gen/android/app/tauri.properties` → `versionName` 与 `versionCode`
- `src-tauri/Cargo.toml` → `version`

> `tauri.properties` 仍会被脚本生成；可以将其提交到仓库，但请勿手动编辑。

### 3. 构建前务必执行同步
本地或 CI/CD 在构建前建议遵循：
```bash
npm install
npm run sync-version   # 或执行 npm version ...
npm run tauri android build
```

如在 CI 流水线，请在 Tauri 构建步骤前新增 `npm run sync-version`，避免版本号回退。

## 📊 版本号对应关系

| 版本号 | versionName | versionCode | 计算公式 |
|--------|-------------|-------------|----------|
| 1.0.0  | 1.0.0       | 10000       | 1×10000 + 0×100 + 0 |
| 1.10.36| 1.10.36     | 11036       | 1×10000 + 10×100 + 36 |
| 1.10.42| 1.10.42     | 11042       | 1×10000 + 10×100 + 42 |
| 1.11.1 | 1.11.1      | 11101       | 1×10000 + 11×100 + 1 |
| 1.2.0  | 1.2.0       | 10200       | 1×10000 + 2×100 + 0 |

### versionCode 规则
- **必须是整数**
- **必须递增**（Android 系统要求）
- **建议公式**：`主版本 × 10000 + 次版本 × 100 + 修订版本`

## 🎯 验证方法

### 本地构建验证
```bash
cd arknights-story-reader
npm run tauri android build

# 检查生成的 APK
# 位置: src-tauri/gen/android/app/build/outputs/apk/universal/release/
# 使用 aapt 查看版本
aapt dump badging app-universal-release.apk | grep version
```

### 安装后验证
```bash
# 在设置 -> 应用中查看
# 应该显示：story-teller 1.11.1
```

## 📝 今后版本更新流程

### 🚀 自动化方式（推荐）

现在已经添加了自动同步脚本，只需两步即可完成版本更新：

#### 方法一：使用 npm version 命令（推荐）
```bash
# 自动升级版本号并同步所有配置
npm version patch   # 1.11.1 -> 1.11.2
npm version minor   # 1.11.1 -> 1.12.0
npm version major   # 1.11.1 -> 2.0.0

# 或者手动指定版本号
npm version 1.11.5
```
**优点**：
- ✅ 自动更新 `package.json` 版本号
- ✅ 自动运行 `sync-version` 脚本同步所有文件
- ✅ 自动 git add 所有更改的文件
- ✅ 自动创建 git tag

#### 方法二：手动更新版本号
```bash
# 1. 手动编辑 package.json 中的 version 字段
# 2. 运行同步脚本
npm run sync-version

# 3. 提交更改
git add .
git commit -m "chore: bump version to x.y.z"
```

### 🔧 自动同步脚本说明

脚本位置：`scripts/sync-version.js`

**功能**：
- 📖 从 `package.json` 读取版本号作为唯一数据源
- 🔢 自动计算 Android versionCode
- 📝 同步更新以下文件：
  1. `src-tauri/Cargo.toml`
  2. `src-tauri/tauri.conf.json`
  3. `src-tauri/gen/android/app/tauri.properties`

**手动运行**：
```bash
npm run sync-version
```

### 📋 旧方法（不推荐，手动维护）

<details>
<summary>点击展开查看手动更新方法</summary>

每次发布新版本时，需要同步更新以下文件：

1. **`package.json`**
   ```json
   "version": "x.y.z"
   ```

2. **`src-tauri/Cargo.toml`**
   ```toml
   version = "x.y.z"
   ```

3. **`src-tauri/tauri.conf.json`**
   ```json
   "version": "x.y.z",
   "android": {
     "versionCode": <按公式计算的整数>
   }
   ```

4. **`src-tauri/gen/android/app/tauri.properties`**
   ```properties
   tauri.android.versionName=x.y.z
   tauri.android.versionCode=<按公式计算的整数>
   ```

</details>

## ⚠️ 重要提醒

### versionCode 必须递增
- ✅ 1.11.1 (versionCode 11101) → 1.11.2 (versionCode 11102)
- ❌ 1.11.1 (versionCode 11101) → 1.2.0 (versionCode 10200)  **降级！会导致无法安装**

### 如果要发布 1.2.0 版本
需要确保 versionCode 大于当前的 11042，例如：
```json
"version": "1.2.0",
"android": {
  "versionCode": 12000  // 或任何 > 11042 的数字
}
```

## 🚀 修复后的效果

- ✅ APK 文件名显示正确版本（例如：1.11.1）
- ✅ 安装后应用信息显示 1.11.1
- ✅ 可以正常覆盖安装旧版本
- ✅ Android 系统正确识别为更新版本

## 🔧 已修复的文件

### 版本同步修复
1. ✅ `src-tauri/tauri.conf.json` - 当前 versionCode：**11101**
2. ✅ `src-tauri/gen/android/app/tauri.properties` - 当前版本：**1.11.1**
3. ✅ 所有配置文件版本号已同步到 **1.11.1**